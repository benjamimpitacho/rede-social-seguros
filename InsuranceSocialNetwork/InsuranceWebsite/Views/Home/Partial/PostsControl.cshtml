@using InsuranceSocialNetworkDTO.Post;
@model InsuranceWebsite.Models.PostItemsViewModel

@Html.HiddenFor(m => m.Items)
@Html.HiddenFor(m => m.Profile)

@*<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">*@
@*<link href="~/Content/bookpost/css/jquery-ui.css" rel="stylesheet" />*@
<script type="text/javascript" src="~/Scripts/jquery.expander.js"></script>

<style>
    .ui-dialog {
        z-index: 1000 !important;
    }

    .ui-front {
        z-index: 1000 !important;
    }

    .ui-widget-overlay{
        z-index: 999 !important;
        opacity: 0.3;
    }
</style>

<div>
    @foreach (PostDTO post in Model.Items)
    {
        <div class="panel panel-white post panel-shadow">

            <div class="post-heading">

                <div class="pull-left image" style="padding:5px">
                    <a href="@Url.Action("ProfileInfo", "Home", new { id = post.PostOwner.ID })">
                        @if (null != post.PostOwner.ProfilePhoto && post.PostOwner.ProfilePhoto.Length > 0)
                        {
                        <img src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(post.PostOwner.ProfilePhoto))" class="avatar" alt="user profile image">
                        }
                        else
                        {
                        <img src="~/Content/images/no_photo_img.jpg" class="avatar" alt="user profile image">
                        }
                    </a>
                </div>

                <div class="pull-left meta" style="margin-bottom: 0px;">

                    <div class="h5" style="font-weight: bold;">

                        <a href="@Url.Action("ProfileInfo", "Home", new { id = post.PostOwner.ID })" class="post-user-name">@post.PostOwner.FirstName</a>

                        @*@switch (post.PostType.Token)
                            {
                                case "IMAGE_POST":
                                    @Resources.Resources.UploadedPhoto;
                                    break;
                                case "TEXT_POST":
                                    @Resources.Resources.MadePost;
                                    break;
                                case "LINK_POST":
                                    @Resources.Resources.MadePost;
                                    break;
                                case "VIDEO_POST":
                                    @Resources.Resources.UploadedVideo;
                                    break;
                                default:
                                    break;
                            }*@

                    </div>

                    @if (post.PostSubject.Token == InsuranceSocialNetworkCore.Enums.PostSubjectEnum.SPONSORED_POST.ToString())
                    {
                    <h6 class="text-muted time">@Resources.Resources.Sponsored.ToUpper()</h6>
                    }
                    else
                    {
                        if (DateTime.Now.Subtract(post.CreateDate).TotalMinutes < 1)
                        {
                    <h6 class="text-muted time">@Math.Round(DateTime.Now.Subtract(post.CreateDate).TotalSeconds, 0) @Resources.Resources.SecondsAgo</h6>
                        }
                        else if (DateTime.Now.Subtract(post.CreateDate).TotalHours < 2)
                        {
                    <h6 class="text-muted time">@Math.Round(DateTime.Now.Subtract(post.CreateDate).TotalMinutes, 0) @Resources.Resources.MinutesAgo</h6>
                        }
                        else if (DateTime.Now.Subtract(post.CreateDate).TotalDays < 1)
                        {
                    <h6 class="text-muted time">@Math.Round(DateTime.Now.Subtract(post.CreateDate).TotalHours, 0) @Resources.Resources.HoursAgo</h6>
                        }
                        else if (DateTime.Now.Subtract(post.CreateDate).TotalDays == 1)
                        {
                    <h6 class="text-muted time">@Math.Round(DateTime.Now.Subtract(post.CreateDate).TotalDays, 0) @Resources.Resources.DayAgo</h6>
                        }
                        else if (DateTime.Now.Subtract(post.CreateDate).TotalDays < 3)
                        {
                    <h6 class="text-muted time">@Math.Round(DateTime.Now.Subtract(post.CreateDate).TotalDays, 0) @Resources.Resources.DaysAgo</h6>
                        }
                        else
                        {
                    <h6 class="text-muted time">@post.CreateDate.ToShortDateString()</h6>
                        }
                    }

                </div>

                <div class="pull-right">
                    @if (post.ID_User == Model.Profile.ID_User)
                    {
                        <i class="glyphicon glyphicon-option-vertical icon context-menu-one" id="menu_@post.ID" style="border:0px;font-size: 24px;margin-right: 10px;"></i>
                    }
                    else
                    {
                        <i class="glyphicon glyphicon-option-vertical icon context-menu-two" id="menu_@post.ID" style="border:0px;font-size: 24px;margin-right: 10px;"></i>
                    }
                </div>

            </div>

            <div class="post-description" style="word-break:normal; text-align:justify;">

                @if (post.PostType.Token == InsuranceSocialNetworkCore.Enums.PostTypeEnum.FILE_POST.ToString())
                {
                    <a id="file_@post.ID" href="@Url.Action("Download", "Home", new { id = post.ID })"><i class="fa fa-file-text-o" aria-hidden="true" style="font-size:30px;padding-left: 15px;padding-right:10px;"></i></a>
                }
                <span id="text_@post.ID">@post.Text</span>

            </div>

            @if (post.PostType.Token == InsuranceSocialNetworkCore.Enums.PostTypeEnum.IMAGE_POST.ToString())
                {

                <div class="post-image">

                    @*<img src="@post.ImageSource" class="image show-in-modal" alt="image post">*@

                    <div id="gallery_@post.ID" class="image show-in-modal"></div>

                    <script>

                        $(function () {

                            $('#gallery_'+@post.ID).imagesGrid({
                                images: [
                                    {
                                        src: '@post.ImageSource'
                                    }
                                ],
                                align: true,
                                getViewAllText: function (imgsCount) { return 'View all' }
                            });

                        });

                    </script>

                </div>
            }

            <div class="post-description" style="border-top: 1px solid #eee;">

                <div class="stats">

                    @if (null != post.PostLike && post.PostLike.Count > 0 && post.PostLike.Exists(i => i.ID_User == Model.Profile.ID_User))
                    {
                    <a onclick="UnlikePost(this, @post.ID, @post.PostLike.Count)" class="stat-item" id="unlikePost" style="color:#00C1DE">
                        <i class="glyphicon glyphicon-star icon"></i><span style="padding-left: 8px;color:#4B5C66;font-size: 10px;">@post.PostLike.Count</span>
                    </a>
                    }
                    else if (null != post.PostLike && post.PostLike.Count > 0)
                    {
                    <a onclick="LikePost(this, @post.ID, @post.PostLike.Count)" class="stat-item" id="likePost">
                        <i class="glyphicon glyphicon-star icon"></i><span style="padding-left: 8px;color:#4B5C66;font-size: 10px;">@post.PostLike.Count</span>
                    </a>
                    }
                    else
                    {
                    @*<a href="@Url.Action("LikePost", "Home", new { postId = post.ID, userId = Model.Profile.ID_User })" class="stat-item">*@
                    <a onclick="LikePost(this, @post.ID, @post.PostLike.Count)" class="stat-item">
                        <i class="glyphicon glyphicon-star icon"></i>
                    </a>
                    }

                    @*<a href="#" class="stat-item">

                            <i class="fa fa-retweet icon"></i>12

                        </a>*@

                    <a class="stat-item">

                        <i class="glyphicon glyphicon-option-horizontal icon"></i>
                        @if (post.PostComment.Count > 0)
                        {
                        <span style="padding-left: 8px;color:#4B5C66;font-size: 10px;">
                            @post.PostComment.Count
                        </span>
                        }

                    </a>

                </div>

            </div>

            @*@if (post.PostSubject.Token != InsuranceSocialNetworkCore.Enums.PostSubjectEnum.SPONSORED_POST.ToString())
                {*@
            <div class="post-footer" style="border-top: 1px solid #eee;">

                @if (null != post.PostComment && post.PostComment.Count > 0)
                {
                <ul class="comments-list">

                    @foreach (PostCommentDTO comment in post.PostComment)
                        {
                        <li class="comment">

                            <a class="pull-left" href="@Url.Action("ProfileInfo", "Home", new { id = comment.CommentOwner.ID })">

                                @if (null != comment.CommentOwner.ProfilePhoto && comment.CommentOwner.ProfilePhoto.Length > 0)
                                    {
                                    <img src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(comment.CommentOwner.ProfilePhoto))" class="avatar" alt="user profile image">
                                    }
                                    else
                                    {
                                    <img src="~/Content/images/no_photo_img.jpg" class="avatar" alt="user profile image">
                                    }

                            </a>

                            <div class="comment-body" style="font-size:12px">

                                <h6 class="comment-user-name"><a href="@Url.Action("ProfileInfo", "Home", new { id = comment.CommentOwner.ID })">@comment.CommentOwner.FirstName</a></h6> @comment.Text

                                <div class="comment-heading">

                                    @if (DateTime.Now.Subtract(comment.Date).TotalMinutes < 1)
                                        {
                                        <h6 class="time">@Math.Round(DateTime.Now.Subtract(comment.Date).TotalSeconds, 0) @Resources.Resources.SecondsAgo</h6>
                                        }
                                        else if (DateTime.Now.Subtract(comment.Date).TotalHours < 1)
                                        {
                                        <h6 class="time">@Math.Round(DateTime.Now.Subtract(comment.Date).TotalMinutes, 0) @Resources.Resources.MinutesAgo</h6>
                                        }
                                        else if (DateTime.Now.Subtract(comment.Date).TotalDays < 1)
                                        {
                                        <h6 class="time">@Math.Round(DateTime.Now.Subtract(comment.Date).TotalHours, 0) @Resources.Resources.HoursAgo</h6>
                                        }
                                        else if (DateTime.Now.Subtract(comment.Date).TotalDays == 1)
                                        {
                                        <h6 class="text-muted time">@Math.Round(DateTime.Now.Subtract(comment.Date).TotalDays, 0) @Resources.Resources.DayAgo</h6>
                                        }
                                        else if (DateTime.Now.Subtract(comment.Date).TotalDays < 3)
                                        {
                                        <h6 class="time">@Math.Round(DateTime.Now.Subtract(comment.Date).TotalDays, 0) @Resources.Resources.DaysAgo</h6>
                                        }
                                        else
                                        {
                                        <h6 class="time">@comment.Date.ToShortDateString()</h6>
                                        }

                                </div>
                            </div>

                        </li>
                        }

                </ul>
                }

                @using (Html.BeginForm("NewComment", "Home", FormMethod.Post, new { @class = "commentForm" }))
                {
                <input type="hidden" id="postId" name="postId" value="@post.ID" />
                <input id="postNewComment" name="postNewComment" class="form-control add-comment-input" placeholder="@Resources.Resources.AddComment" type="text" />
                }
            </div>
            @*}*@

        </div>
    }
</div>

<div id="dialog-confirm-delete" style="display: none"></div>
<div id="dialog-confirm-hide" style="display: none"></div>
<div id="dialog-confirm-edit" style="display:none;height:auto;"></div>

<script type="text/javascript">

    $(function () {

        var url = "";
        var postId = 0;

        $('.post-description').expander({
            slicePoint: 500,
            expandText: '@Resources.Resources.ReadMore',
            userCollapseText: '@Resources.Resources.ReadLess'
        });

        $(".commentForm").on("submit", function(e) {
            e.preventDefault();  //prevent form from submitting

            if($(e.target).parent().children(".comments-list").length == 0)
            {
                //alert("nao ha comments list");
                $(e.target).parent().prepend("<ul class=\"comments-list\"></ul>");
            }

            $(e.target).parent().children(".comments-list").append("<li class=\"comment\"><a class=\"pull-left\" href=\"/Home/ProfileInfo/@Model.Profile.ID\"><img src=\"@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(Model.Profile.ProfilePhoto))\" class=\"avatar\" ></a><div class=\"comment-body\" style=\"font-size:12px\"><h6 class=\"comment-user-name\"><a href=\"/Home/ProfileInfo/1\">Administrator</a></h6> " + $(e.target).children("#postNewComment").val() + "<div class=\"comment-heading\"><h6 class=\"time\">@Resources.Resources.Now</h6></div></div></li>");
            jQuery.post('@Url.Action("NewComment", "Home")',
                { postId: $(e.target).children("#postId").val(), postNewComment: $(e.target).children("#postNewComment").val(), hasNotification: true }
            )
            .done(function (data) {
                //alert("retorno do comment:" + data);
            })
            .fail(function () {
                //alert("falhou...");
            });

            $(e.target).children("#postNewComment").val("");

        });

        $.contextMenu({
            selector: '.context-menu-one',
            callback: function (key, options) {
                //var m = "clicked: " + key;
                //window.console && console.log(m) || alert(m);
                postId = options.$trigger.attr("id").replace("menu_", "");
                switch (key)
                {
                    case "hide":
                        @*url = "@Url.Action("HidePost", "Home")" + "/" + postId;*@
                        $("#dialog-confirm-hide").dialog('open');
                        break;
                    case "edit":
                        $("#dialog-confirm-edit").dialog('open');
                        //alert($("#postContentTextarea").id);
                        //alert($("#text_" + options.$trigger.attr("id").replace("menu_", "")).text());
                        //$("#postContentTextarea").text = $("#text_" + options.$trigger.attr("id").replace("menu_", "")).text();
                        break;
                    case "delete":
                        //url = "@Url.Action("DeletePost", "Home")" + "/" + postId;
                        $("#dialog-confirm-delete").dialog('open');
                        break;
                    default: break;
                }
            },
            items: {
                "edit": { name: "@Resources.Resources.Edit", icon: "edit" },
                "hide": { name: "@Resources.Resources.Hide", icon: "hide" },
                "sep1": "---------",
                "delete": { name: "@Resources.Resources.Delete", icon: "delete" }
            }
        });

        $.contextMenu({
            selector: '.context-menu-two',
            callback: function (key, options) {
                postId = options.$trigger.attr("id").replace("menu_", "");
                switch (key)
                {
                    case "hide":
                        @*url = "@Url.Action("HidePost", "Home")" + "/" + postId;*@
                        $("#dialog-confirm-hide").dialog('open');
                        break;
                    default: break;
                }
            },
            items: {
                @*"edit": { name: "@Resources.Resources.Edit", icon: "edit" },*@
                "hide": { name: "@Resources.Resources.Hide", icon: "hide" }
                //"sep1": "---------",
                @*"delete": { name: "@Resources.Resources.Delete", icon: "delete" }*@
            }
        });

        $('.context-menu-one').on('click', function (e) {
            console.log('clicked', this);
        });

        $('.context-menu-two').on('click', function (e) {
            console.log('clicked', this);
        });

        $("#dialog-confirm-delete").dialog({
            title: '@Resources.Resources.Delete',
            autoOpen: false,
            resizable: false,
            width: 400,
            height: 150,
            show: { effect: 'drop', direction: "up" },
            modal: true,
            draggable: true,
            open: function (e, ui) {
                $(this).load("@Url.Action("ConfirmPostDelete", "Home")" + "/" + postId);
            },
            buttons: {}
        });

        $("#dialog-confirm-hide").dialog({
            title: '@Resources.Resources.Hide',
            autoOpen: false,
            resizable: false,
            width: 400,
            height: 150,
            show: { effect: 'drop', direction: "up" },
            modal: true,
            draggable: true,
            open: function (event, ui) {
                $(this).load("@Url.Action("ConfirmPostHide", "Home")" + "/" + postId);
            },
            buttons: {}
        });

        $("#dialog-confirm-edit").dialog({
            title: '@Resources.Resources.Edit',
            autoOpen: false,
            resizable: false,
            height: 550,
            width: 450,
            show: { effect: 'drop', direction: "up" },
            modal: true,
            draggable: true,
            open: function (event, ui) {
                $(this).load("@Url.Action("EditPostDialog", "Home")" + "/" + postId);
            },
            buttons: {}
        });
    });

    function LikePost(object, postId, likesCount) {
        object.style.color = "#00C1DE";
        object.innerHTML = "<i class=\"glyphicon glyphicon-star icon\"></i><span style=\"padding-left: 8px;color:#4B5C66;font-size: 10px;\">" + (likesCount+1) + "</span>";
        likesCount = likesCount + 1;
        object.onclick = function() { UnlikePost(object, postId, likesCount); }

        jQuery.post('@Url.Action("LikePost", "Home")',
                { postId: postId }
            )
            .done(function (data) {
            })
            .fail(function () {
            });
    }

    function UnlikePost(object, postId, likesCount) {
        object.style.color = "#7f7f7f";
        if(likesCount <= 1)
        {
            object.innerHTML = "<i class=\"glyphicon glyphicon-star icon\"></i>";
        }
        else
        {
            object.innerHTML = "<i class=\"glyphicon glyphicon-star icon\"></i><span style=\"padding-left: 8px;color:#4B5C66;font-size: 10px;\">" + (likesCount-1) + "</span>";
        }
        if(likesCount > 0)
        {
            likesCount = likesCount - 1;
        }
        object.onclick = function() { LikePost(object, postId, likesCount); }

        jQuery.post('@Url.Action("UnlikePost", "Home")',
                { postId: postId }
            )
            .done(function (data) {
            })
            .fail(function () {
            });
    }

</script>
